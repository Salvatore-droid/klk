{% extends "index.html" %}
{% load static %}

{% block content %}
<style>
    :root {
        --primary: #4361ee;
        --primary-dark: #3a56d4;
        --primary-light: #eef2ff;
        --secondary: #3f37c9;
        --accent: #4895ef;
        --success: #4cc9f0;
        --info: #4361ee;
        --warning: #f8961e;
        --danger: #f72585;
        --dark: #1a1a2e;
        --darker: #16213e;
        --light: #f8f9fa;
        --lighter: #f1f3f9;
        --gray: #6c757d;
        --gray-light: #e9ecef;
        --white: #ffffff;
        --header-height: 80px;
        --shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        --shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 1rem 3rem rgba(0, 0, 0, 0.175);
        --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        --border-radius: 0.375rem;
        --border-radius-lg: 0.5rem;
        --border-radius-xl: 1rem;
    }

    /* Main Content Styles */
    .main-content {
        flex: 1;
        margin-left: var(--sidebar-width, 280px);
        padding: 2rem;
        transition: var(--transition);
        background-color: var(--lighter);
        min-height: 100vh;
    }

    /* Header Styles */
    .main-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2.5rem;
        padding: 1.5rem 2rem;
        background: linear-gradient(135deg, var(--white) 0%, var(--lighter) 100%);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow);
        animation: fadeInDown 0.6s ease;
        border-left: 4px solid var(--primary);
    }

    .main-header h1 {
        font-size: 2rem;
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 0.5rem;
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .main-header p {
        color: var(--gray);
        font-size: 0.95rem;
        margin: 0;
    }

    .header-right {
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }

    .search-bar {
        position: relative;
    }

    .search-bar input {
        padding: 0.75rem 1rem 0.75rem 3rem;
        border-radius: 50px;
        border: 1px solid var(--gray-light);
        background-color: var(--white);
        font-size: 0.925rem;
        width: 280px;
        transition: var(--transition);
        box-shadow: var(--shadow-sm);
    }

    .search-bar input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.2);
        width: 320px;
    }

    .search-bar i {
        position: absolute;
        left: 1.25rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray);
        font-size: 0.95rem;
    }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .notification-btn, .message-btn, .profile-btn {
        position: relative;
        color: var(--dark);
        font-size: 1.2rem;
        cursor: pointer;
        transition: var(--transition);
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background-color: var(--white);
        box-shadow: var(--shadow-sm);
    }

    .notification-btn:hover, .message-btn:hover, .profile-btn:hover {
        color: var(--primary);
        transform: translateY(-2px);
        box-shadow: var(--shadow);
    }

    .notification-badge {
        position: absolute;
        top: -3px;
        right: -3px;
        background-color: var(--danger);
        color: var(--white);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.65rem;
        font-weight: 700;
        border: 2px solid var(--lighter);
    }

    .profile-btn img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--primary-light);
    }

    /* Financial Aid Container */
    .financial-container {
        background-color: var(--white);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow);
        padding: 2rem;
        margin-bottom: 2rem;
        animation: fadeIn 0.8s ease;
        border: 1px solid var(--gray-light);
    }

    .financial-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--gray-light);
    }

    .financial-header h2 {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--dark);
        position: relative;
        padding-left: 1.5rem;
    }

    .financial-header h2::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 6px;
        height: 30px;
        background: linear-gradient(to bottom, var(--primary), var(--accent));
        border-radius: 3px;
    }

    .financial-actions {
        display: flex;
        gap: 1rem;
    }

    /* Button Styles */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.5rem;
        border-radius: var(--border-radius);
        font-size: 0.925rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        border: none;
        box-shadow: var(--shadow-sm);
        text-decoration: none;
        gap: 0.5rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        color: var(--white);
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary) 100%);
        transform: translateY(-2px);
        box-shadow: var(--shadow);
    }

    .btn-secondary {
        background-color: var(--white);
        color: var(--primary);
        border: 1px solid var(--primary-light);
    }

    .btn-secondary:hover {
        background-color: var(--primary-light);
        transform: translateY(-2px);
        box-shadow: var(--shadow);
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
    }

    /* Financial Metrics */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2.5rem;
    }

    .metric-card {
        background: linear-gradient(135deg, var(--white) 0%, var(--lighter) 100%);
        border-radius: var(--border-radius-lg);
        padding: 1.75rem;
        box-shadow: var(--shadow);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
        border: 1px solid var(--gray-light);
    }

    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(67, 97, 238, 0.05) 0%, rgba(255, 255, 255, 0) 100%);
        z-index: 1;
        opacity: 0;
        transition: var(--transition);
    }

    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .metric-card:hover::before {
        opacity: 1;
    }

    .metric-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--gray);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .metric-title i {
        font-size: 1.1rem;
        color: var(--primary);
    }

    .metric-value {
        font-size: 2rem;
        font-weight: 800;
        color: var(--dark);
        margin-bottom: 0.5rem;
        line-height: 1.2;
    }

    .metric-value.currency {
        font-size: 1.75rem;
    }

    .metric-change {
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        font-weight: 600;
        gap: 0.25rem;
    }

    .metric-change i {
        font-size: 0.8rem;
    }

    .metric-change.positive {
        color: var(--success);
    }

    .metric-change.negative {
        color: var(--danger);
    }

    /* Filters Section */
    .filters-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2.5rem;
        padding: 1.75rem;
        background-color: var(--lighter);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--gray-light);
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-group label {
        display: block;
        margin-bottom: 0.75rem;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--dark);
    }

    .filter-select {
        width: 100%;
        padding: 0.75rem 1rem;
        border-radius: var(--border-radius);
        border: 1px solid var(--gray-light);
        background-color: var(--white);
        font-size: 0.925rem;
        transition: var(--transition);
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236c757d' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 14px 10px;
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.2);
    }

    .filter-actions {
        display: flex;
        align-items: flex-end;
        gap: 1rem;
    }

    /* Charts Section */
    .charts-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 2rem;
        margin-bottom: 2.5rem;
    }

    .chart-card {
        background-color: var(--white);
        border-radius: var(--border-radius-lg);
        padding: 2rem;
        box-shadow: var(--shadow);
        transition: var(--transition);
        border: 1px solid var(--gray-light);
    }

    .chart-card:hover {
        box-shadow: var(--shadow-lg);
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.75rem;
    }

    .chart-header h3 {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--dark);
        position: relative;
        padding-left: 1.25rem;
    }

    .chart-header h3::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 5px;
        height: 24px;
        background: linear-gradient(to bottom, var(--primary), var(--accent));
        border-radius: 2.5px;
    }

    .chart-tabs {
        display: flex;
        gap: 0.5rem;
        background-color: var(--lighter);
        border-radius: 50px;
        padding: 0.375rem;
    }

    .chart-tab {
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        border: none;
        background-color: transparent;
        color: var(--gray);
    }

    .chart-tab.active {
        background-color: var(--white);
        color: var(--primary);
        box-shadow: var(--shadow-sm);
    }

    .chart-container {
        position: relative;
        height: 350px;
        width: 100%;
    }

    /* Financial Aid Table */
    .table-container {
        background-color: var(--white);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow);
        overflow: hidden;
        margin-top: 2rem;
        border: 1px solid var(--gray-light);
    }

    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem 2rem;
        background-color: var(--lighter);
        border-bottom: 1px solid var(--gray-light);
    }

    .table-header h3 {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--dark);
        margin: 0;
    }

    .financial-table {
        width: 100%;
        border-collapse: collapse;
    }

    .financial-table thead th {
        padding: 1.25rem 1.5rem;
        font-weight: 700;
        color: var(--dark);
        background-color: var(--lighter);
        border-bottom: 2px solid var(--gray-light);
        text-align: left;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .financial-table tbody td {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--gray-light);
        vertical-align: middle;
        font-size: 0.925rem;
    }

    .financial-table tbody tr {
        transition: var(--transition);
    }

    .financial-table tbody tr:hover {
        background-color: var(--primary-light);
    }

    /* Status Badges */
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        gap: 0.375rem;
    }

    .status-approved {
        background-color: rgba(76, 201, 240, 0.15);
        color: var(--success);
        border: 1px solid rgba(76, 201, 240, 0.3);
    }

    .status-pending {
        background-color: rgba(248, 150, 30, 0.15);
        color: var(--warning);
        border: 1px solid rgba(248, 150, 30, 0.3);
    }

    .status-rejected {
        background-color: rgba(247, 37, 133, 0.15);
        color: var(--danger);
        border: 1px solid rgba(247, 37, 133, 0.3);
    }

    .status-disbursed {
        background-color: rgba(67, 97, 238, 0.15);
        color: var(--primary);
        border: 1px solid rgba(67, 97, 238, 0.3);
    }

    /* Currency Format */
    .currency-amount {
        font-weight: 700;
        color: var(--dark);
        font-family: 'Courier New', monospace;
    }

    .currency-amount::before {
        content: 'KES ';
        font-weight: 600;
        color: var(--gray);
    }

    /* Student Avatar */
    .student-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 0.75rem;
        border: 2px solid var(--primary-light);
        box-shadow: var(--shadow-sm);
    }

    /* Action Buttons */
    .action-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: var(--lighter);
        color: var(--gray);
        border: none;
        cursor: pointer;
        transition: var(--transition);
        margin-right: 0.5rem;
    }

    .action-btn:hover {
        color: var(--white);
        transform: scale(1.1);
    }

    .action-btn.view:hover {
        background-color: var(--primary);
    }

    .action-btn.edit:hover {
        background-color: var(--warning);
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .charts-section {
            grid-template-columns: 1fr;
        }
        
        .metrics-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 992px) {
        .main-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1.5rem;
        }
        
        .header-right {
            width: 100%;
            justify-content: space-between;
        }
        
        .search-bar input {
            width: 250px;
        }
        
        .search-bar input:focus {
            width: 280px;
        }
        
        .filters-section {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .main-content {
            padding: 1.5rem;
        }
        
        .metrics-grid {
            grid-template-columns: 1fr;
        }
        
        .financial-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1.5rem;
        }
        
        .financial-actions {
            width: 100%;
            justify-content: flex-start;
        }
        
        .header-right {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }
        
        .search-bar input {
            width: 100%;
        }
        
        .search-bar input:focus {
            width: 100%;
        }
        
        .header-actions {
            width: 100%;
            justify-content: space-between;
        }
        
        .financial-table {
            display: block;
            overflow-x: auto;
            white-space: nowrap;
        }
    }

    @media (max-width: 576px) {
        .chart-card {
            padding: 1.5rem;
        }
        
        .chart-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .chart-tabs {
            width: 100%;
            justify-content: center;
        }
        
        .table-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
    }

    /* Animations */
    @keyframes fadeIn {
        from { opacity:0; transform: translateY(20px); }
        to { opacity:1; transform: translateY(0); }
    }

    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Utility Classes */
    .text-center {
        text-align: center;
    }

    .py-4 {
        padding-top: 1.5rem;
        padding-bottom: 1.5rem;
    }

    .tooltip {
        position: relative;
    }

    .tooltip::after {
        content: attr(data-tooltip);
        position: absolute;
        left: 50%;
        bottom: 100%;
        transform: translateX(-50%);
        background-color: var(--dark);
        color: var(--white);
        padding: 0.5rem 0.75rem;
        border-radius: var(--border-radius);
        font-size: 0.8rem;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: var(--transition);
        z-index: 100;
        margin-bottom: 10px;
    }

    .tooltip:hover::after {
        opacity: 1;
        visibility: visible;
    }
</style>

<header class="main-header">
    <div class="header-left">
        <h1>Financial Aid Management</h1>
        <p>Track and manage all scholarship disbursements and financial support</p>
    </div>
    <div class="header-right">
        <form method="GET" action="{% url 'financial_aid_list' %}" class="search-bar">
            <input type="text" name="search" placeholder="Search beneficiaries, sponsors..." value="{{ request.GET.search }}">
            <i class="fas fa-search"></i>
        </form>
        <div class="header-actions">
            <div class="notification-btn tooltip" data-tooltip="Notifications">
                <i class="fas fa-bell"></i>
                <span class="notification-badge">{{ unread_notifications }}</span>
            </div>
            <div class="message-btn tooltip" data-tooltip="Messages">
                <i class="fas fa-envelope"></i>
            </div>
            <div class="profile-btn">
                {% if user.profile_picture %}
                    <img src="{{ user.profile_picture.url }}" alt="Profile picture">
                {% else %}
                    <img src="{% static 'images/avatar.jpg' %}" alt="Default profile picture">
                {% endif %}
            </div>
        </div>
    </div>
</header>

<!-- Financial Aid Section -->
<section class="financial-container">
    <div class="financial-header">
        <h2>Scholarship Disbursements</h2>
        <div class="financial-actions">
            <a href="{% url 'add_financial_aid' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> New Disbursement
            </a>
            <a href="{% url 'financial_reports' %}" class="btn btn-secondary">
                <i class="fas fa-file-export"></i> Export Report
            </a>
        </div>
    </div>

    <!-- Financial Metrics -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-title">
                <i class="fas fa-wallet"></i> Total Disbursed
            </div>
            <div class="metric-value currency">KES {{ total_disbursed|floatformat:2|default:"0.00" }}</div>
            <div class="metric-change positive">
                <i class="fas fa-arrow-up"></i> {{ academic_year }}
            </div>
        </div>
        <div class="metric-card">
            <div class="metric-title">
                <i class="fas fa-users"></i> Beneficiaries Supported
            </div>
            <div class="metric-value">{{ beneficiaries_supported|default:0 }}</div>
            <div class="metric-change positive">
                <i class="fas fa-arrow-up"></i> Current Year
            </div>
        </div>
        <div class="metric-card">
            <div class="metric-title">
                <i class="fas fa-hand-holding-usd"></i> Average Award
            </div>
            <div class="metric-value currency">KES {{ average_award|floatformat:2|default:"0.00" }}</div>
            <div class="metric-change">
                <i class="fas fa-percentage"></i> Per Beneficiary
            </div>
        </div>
        <div class="metric-card">
            <div class="metric-title">
                <i class="fas fa-piggy-bank"></i> Remaining Budget
            </div>
            <div class="metric-value currency">KES {{ remaining_budget|floatformat:2|default:"0.00" }}</div>
            <div class="metric-change positive">
                <i class="fas fa-percentage"></i> 
                {% if total_budget and total_budget > 0 %}
                    {% widthratio remaining_budget total_budget 100 %}%
                {% else %}
                    0%
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <form method="GET" action="{% url 'financial_aid_list' %}" class="filters-section">
        <div class="filter-group">
            <label for="education_level">Education Level</label>
            <select id="education_level" name="education_level" class="filter-select">
                <option value="">All Levels</option>
                {% for level in education_levels %}
                    <option value="{{ level.0 }}" {% if request.GET.education_level == level.0 %}selected{% endif %}>{{ level.1 }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="status">Status</label>
            <select id="status" name="status" class="filter-select">
                <option value="">All Statuses</option>
                {% for status in status_choices %}
                    <option value="{{ status.0 }}" {% if request.GET.status == status.0 %}selected{% endif %}>{{ status.1 }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="year">Academic Year</label>
            <select id="year" name="year" class="filter-select">
                <option value="">All Years</option>
                {% for year in academic_years %}
                    <option value="{{ year }}" {% if request.GET.year == year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="sponsor">Sponsor</label>
            <select id="sponsor" name="sponsor" class="filter-select">
                <option value="">All Sponsors</option>
                {% for sponsor in sponsors %}
                    <option value="{{ sponsor.id }}" {% if request.GET.sponsor == sponsor.id|stringformat:"s" %}selected{% endif %}>{{ sponsor.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-actions">
            <button type="submit" class="btn btn-primary">Apply Filters</button>
            <a href="{% url 'financial_aid_list' %}" class="btn btn-secondary">Clear</a>
        </div>
    </form>

    <!-- Charts Section -->
    <div class="charts-section">
        <div class="chart-card">
            <div class="chart-header">
                <h3>Disbursement Trends</h3>
                <div class="chart-tabs">
                    <button class="chart-tab active">By Term</button>
                    <button class="chart-tab">By Level</button>
                    <button class="chart-tab">By Region</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="disbursementTrendChart"></canvas>
            </div>
        </div>
        
        <div class="chart-card">
            <div class="chart-header">
                <h3>Funding Sources</h3>
                <div class="chart-tabs">
                    <button class="chart-tab active">{{ academic_year }}</button>
                    <button class="chart-tab">All Years</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="fundingSourcesChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Disbursements Table -->
    <div class="table-container">
        <div class="table-header">
            <h3>Recent Disbursements</h3>
            <a href="{% url 'financial_aid_list' %}" class="btn btn-secondary btn-sm">
                View All <i class="fas fa-chevron-right"></i>
            </a>
        </div>
        <table class="financial-table">
            <thead>
                <tr>
                    <th>Beneficiary</th>
                    <th>Institution</th>
                    <th>Amount</th>
                    <th>Payment Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for aid in recent_disbursements %}
                <tr>
                    <td>
                        <div style="display: flex; align-items: center;">
                            <img src="{% if aid.beneficiary.photo %}{{ aid.beneficiary.photo.url }}{% else %}{% static 'img/default-avatar.png' %}{% endif %}" alt="Student" class="student-avatar">
                            <div>
                                <div style="font-weight: 600;">{{ aid.beneficiary.first_name }} {{ aid.beneficiary.last_name }}</div>
                                <div style="font-size: 0.8rem; color: var(--gray);">{{ aid.beneficiary.get_current_level_display }}</div>
                            </div>
                        </div>
                    </td>
                    <td>{% if aid.beneficiary.institution %}{{ aid.beneficiary.institution.name }}{% else %}--{% endif %}</td>
                    <td><span class="currency-amount">{{ aid.amount_approved|floatformat:2|default:"0.00" }}</span></td>
                    <td>{{ aid.disbursement_date|date:"d M Y"|default:"--" }}</td>
                    <td>
                        {% if aid.status == 'approved' %}
                            <span class="status-badge status-approved">Approved</span>
                        {% elif aid.status == 'pending' %}
                            <span class="status-badge status-pending">Pending</span>
                        {% elif aid.status == 'rejected' %}
                            <span class="status-badge status-rejected">Rejected</span>
                        {% elif aid.status == 'disbursed' %}
                            <span class="status-badge status-disbursed">Disbursed</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'financial_aid_detail' pk=aid.pk %}" class="action-btn view" title="View Details"><i class="fas fa-eye"></i></a>
                        <a href="{% url 'update_financial_aid_status' pk=aid.pk %}" class="action-btn edit" title="Edit"><i class="fas fa-edit"></i></a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center py-4">No recent disbursements found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    // Initialize charts
    const trendCtx = document.getElementById('disbursementTrendChart').getContext('2d');
    const trendChart = new Chart(trendCtx, {
        type: 'bar',
        data: {
            labels: ['Term 1', 'Term 2', 'Term 3'],
            datasets: [
                {
                    label: '{{ academic_year }} Disbursements',
                    data: [1250000, 1450000, 1587500],
                    backgroundColor: 'rgba(67, 97, 238, 0.8)',
                    borderColor: '#4361ee',
                    borderWidth: 1,
                    borderRadius: 6
                },
                {
                    label: 'Previous Year Disbursements',
                    data: [1100000, 1300000, 1400000],
                    backgroundColor: 'rgba(76, 201, 240, 0.8)',
                    borderColor: '#4cc9f0',
                    borderWidth: 1,
                    borderRadius: 6
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    align: 'end',
                    labels: {
                        usePointStyle: true,
                        padding: 20,
                        font: {
                            weight: '600'
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'KES ' + context.raw.toLocaleString();
                        }
                    },
                    backgroundColor: 'rgba(26, 26, 46, 0.95)',
                    titleFont: {
                        weight: '600'
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        drawBorder: false,
                        color: 'rgba(108, 117, 125, 0.1)'
                    },
                    ticks: {
                        callback: function(value) {
                            return 'KES ' + (value / 1000) + 'K';
                        },
                        font: {
                            weight: '600'
                        }
                    }
                }
            }
        }
    });

    // Funding Sources Chart
    const fundingCtx = document.getElementById('fundingSourcesChart').getContext('2d');
    const fundingChart = new Chart(fundingCtx, {
        type: 'doughnut',
        data: {
            labels: ['ABC Foundation', 'XYZ Corporation', 'Individual Donors', 'Government Grants'],
            datasets: [{
                data: [45, 30, 15, 10],
                backgroundColor: [
                    '#4361ee',
                    '#4895ef',
                    '#4cc9f0',
                    '#f8961e'
                ],
                borderWidth: 0,
                hoverOffset: 15
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        pointStyle: 'circle',
                        font: {
                            weight: '600'
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            return `${label}: ${value}%`;
                        }
                    },
                    backgroundColor: 'rgba(26, 26, 46, 0.95)'
                }
            },
            cutout: '65%',
            animation: {
                animateScale: true,
                animateRotate: true
            }
        }
    });

    // Tab functionality for charts
    $('.chart-tab').on('click', function() {
        // Remove active class from all tabs in this group
        $(this).siblings('.chart-tab').removeClass('active');
        // Add active class to clicked tab
        $(this).addClass('active');
        // Here you would typically update the chart data based on the selected tab
    });

    // Submit filter form on select change
    $('#education_level, #status, #year, #sponsor').on('change', function() {
        $(this).closest('form').submit();
    });

    // Add hover effects to table rows
    $('.financial-table tbody tr').hover(
        function() {
            $(this).css('transform', 'translateX(5px)');
        },
        function() {
            $(this).css('transform', 'translateX(0)');
        }
    );
});
</script>
{% endblock %}